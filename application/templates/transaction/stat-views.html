{% extends 'base.html' %}

{% block layout_content %}

    <div class="container-fluid">
        <div class="row">
            <div class="col-lg-2">
                    {% include 'includes/menu-recording.html' %}
            </div>
            <div class="col-lg-10">
                <section>
                        <ol class="breadcrumb">
                          <li><a href="{{ url_for('Recording') }}">Recording</a></li>
                          <li><a href="{{ url_for('Transaction_Index') }}">Transaction</a></li>
                          <li class="active">Statistics</li>
                        </ol>
                        <div class="row">
                            <div class="col-lg-8">
                                <h3>{{ current_agency.name }}</h3>
                                <hr/>
                                <ul id="myTab" class="nav nav-tabs nav-tabs-google">
                                  <li ><a href="#transaction" data-toggle="tab">Transaction information</a></li>
                                  <li class="active"><a href="#employee" data-toggle="tab">Employee transaction</a></li>
                                </ul>
                                <br/>
                            <div id="myTabContent" class="tab-content">
                                <div class="tab-pane fade " id="transaction">
                                    <div class="panel panel-info">
                                        <div class="panel-heading"><span class="lead">Transaction List</span></div>
                                          <div class="panel-body">
                                            <table class="table table-hover" id="dataTableStat1">
                                                <thead>
                                                <tr>
                                                    <th>Date</th>
                                                    <th>Amout</th>
                                                </tr>
                                                </thead>
                                                <tbody>
                                                    {% for transaction in transaction_agency_query %}
                                                        <tr {% if not transaction.is_payment %} class="danger" {% else %} class="success" {% endif %}>
                                                            <td>{{ transaction.transaction_date }}</td>
                                                            <td>{{ transaction.amount|format_price() }} {{ transaction.destination.get().currency.get().code }} </td>
                                                        </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                          </div>
                                    </div>
                                </div>
                                <div class="tab-pane fade active in" id="employee">
                                    <div class="panel panel-info">
                                        <div class="panel-heading"><span class="lead">Employee local ticket transaction</span></div>
                                        <div class="panel-body">
                                            <table class="table table-hover" id="dataTableStat2">
                                                <thead>
                                                <tr>
                                                    <th>Employee</th>
                                                    <th>Selling Ticket </th>
                                                    <th>Escrow Amount</th>
                                                </tr>
                                                </thead>
                                                <tbody>
                                                    {% for user in user_agency %}
                                                        {% if user.escrow_amount() %}
                                                            <tr id="{{ user.key.id() }}" class="dblClickEmpLocal">
                                                                <td><strong>{{ user.last_name }} {{ user.first_name }}</strong></td>
                                                                <td>{{ user.ticket_number_selling() }}</td>
                                                                <td>{{ user.escrow_amount() }}</td>
                                                            </tr>
                                                        {% endif %}
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                    <hr/>
                                    <div class="panel panel-info">
                                        <div class="panel-heading"><span class="lead">Employee foreign ticket transaction</span></div>
                                        <div class="panel-body">
                                            <table class="table table-hover" id="dataTableStat3">
                                                <thead>
                                                <tr>
                                                    <th>Employee</th>
                                                    <th>Travel</th>
                                                    <th>Selling Ticket </th>
                                                    <th>Escrow Amount</th>
                                                </tr>
                                                </thead>
                                                <tbody>
                                                    {% for travel in ticket_travel_query %}
                                                        {% for user in user_agency %}
                                                            {% if travel.travel_ticket.get().destination_start != user.agency.get().destination and travel.ticket_seller == user.key %}
                                                                <tr>
                                                                    <td><strong>{{ user.last_name }} {{ user.first_name }}</strong></td>
                                                                    <td>{{ travel.travel_ticket.get().destination_start.get().name }} - {{ travel.travel_ticket.get().destination_check.get().name }}</td>
                                                                    <td>{{ user.foreign_escrow_and_number_ticket(travel.travel_ticket, ticket_travel_query)['number'] }} </td>
                                                                    <td>{{ user.foreign_escrow_and_number_ticket(travel.travel_ticket, ticket_travel_query)['escrow']|format_price() }} {{ user.foreign_escrow_and_number_ticket(travel.travel_ticket, ticket_travel_query)['currency'] }}</td>
                                                                </tr>
                                                            {% endif %}
                                                        {% endfor %}
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>

                                </div>
                            </div>

                            </div>

                            <div class="col-lg-4">


                                <div class="well text-center">
                                    POS <small>Escrow Amount </small>
                                    <br/><br/>
                                    <table class="table table-condensed">
                                        <tbody>
                                            <tr>
                                                <td>LOCAL</td>
                                                <td>{{ current_agency.escrow_amount()|format_price() }} {{ current_agency.destination.get().currency.get().code }}</td>
                                            </tr>
                                            {% for destination in destination_transaction_query %}
                                                {% if current_agency.escrow_amount_foreign(destination.destination, destination_transaction_query)['currency'] != 0  %}
                                                    <tr>
                                                        <td>{{ destination.destination.get().name }}</td>
                                                        <td>
                                                            {{ current_agency.escrow_amount_foreign(destination.destination, destination_transaction_query)['amount']|format_price() }}

                                                            {{ current_agency.escrow_amount_foreign(destination.destination, destination_transaction_query)['currency'] }}
                                                        </td>
                                                    </tr>
                                                {% endif %}
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                                <hr/>
                                <div class="well text-center">
                                    Agency <small>Escrow Amount </small>
                                    <br/><br/>
                                    <table class="table table-condensed">
                                        <tbody>
                                            <tr>
                                                <td>LOCAL</td>
                                                <td>{{ current_agency.escrow_amount(True)|format_price() }} {{ current_agency.destination.get().currency.get().code }}</td>
                                            </tr>
                                            {% for destination in destination_transaction_query %}
                                                {% if current_agency.escrow_amount_foreign(destination.destination, destination_transaction_query)['currency'] != 0  %}
                                                    <tr>
                                                        <td>{{ destination.destination.get().name }}</td>
                                                        <td>
                                                            {{ current_agency.escrow_amount_foreign(destination.destination, destination_transaction_query, True)['amount']|format_price() }}

                                                            {{ current_agency.escrow_amount_foreign(destination.destination, destination_transaction_query, True)['currency'] }}
                                                        </td>
                                                    </tr>
                                                {% endif %}
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>


                            </div>
                        </div>

                </section>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="myModal" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">


        </div>
      </div>
    </div>
{% endblock %}
{% block footer_script %}
    <script>
        $('#dataTableStat1').dataTable({
            "paging": true,
            "sPaginationType":"full_numbers",
            "iDisplayLength": 25,
            "bFilter": false,
            'aoColumnDefs': [
                {'bSortable': false, 'aTargets': ['nosort']},
                {'bSearchable': false, "aTargets": ['nosort']}
            ],
             "order": [[ 0, "desc" ]]
        });

        $('#dataTableStat2').dataTable({
            "paging": true,
            "bFilter": true,
            'aoColumnDefs': [
                {'bSortable': false, 'aTargets': ['nosort']},
                {'bSearchable': false, "aTargets": ['nosort']}
            ],
             "order": [[ 0, "asc" ]]
        });
         $('#dataTableStat3').dataTable({
            "paging": true,
            "bFilter": true,
            'aoColumnDefs': [
                {'bSortable': false, 'aTargets': ['nosort']},
                {'bSearchable': false, "aTargets": ['nosort']}
            ],
             "order": [[ 0, "asc" ]]
        });
        $('#myTab a').click(function (e) {
          e.preventDefault()
          $(this).tab('show')
        })

        $('.dblClickEmpLocal').mousedown(function(e){
            e.preventDefault();
            $(this).on('click',function(e){
                e.preventDefault();
                var id = $(this).attr('id');
                var url_modal = "{{ url_for('Transaction_user') }}"+"/"+id;
                $('#myModal').modal( {
                    backdrop: 'static',
                    show: true
                });
                $.get(url_modal, function(data) {
                  $('.modal-content').empty().html(data);
                });
            });

        })

    </script>
{% endblock %}